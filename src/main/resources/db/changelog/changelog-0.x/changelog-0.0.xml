<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="add-tag-0.0" author="Igor_M">
        <tagDatabase tag="v.0.0"/>
    </changeSet>

    <changeSet id="create_table_categories" author="Igor_M">
        <createTable tableName="categories">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(127)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(1024)"/>
            <column name="architect_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="designed_date" type="date">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create_table_state_templates" author="Igor_M">
        <createTable tableName="state_templates">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(127)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(1024)"/>
            <column name="category_id" type="bigint"/>
            <column name="architect_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="designed_date" type="date">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_foreign_key_constraint:state_templates:category_id:categories.id" author="Igor_M">
        <addForeignKeyConstraint
                constraintName="fk_category_id"
                baseTableName="state_templates"
                baseColumnNames="category_id"
                onDelete="SET NULL"
                referencedTableName="categories"
                referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="add_index:state_templates:category_id" author="Igor_M">
        <createIndex tableName="state_templates" indexName="idx:state_templates:category_id">
            <column name="category_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="create_table:process_templates" author="Igor_M">
        <createTable tableName="process_templates">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(127)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(1024)"/>
            <column name="architect_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="designed_date" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create_table:states" author="Igor_M">
        <createTable tableName="states">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="process_template_id" type="bigint">
                <constraints
                        nullable="false"
                        foreignKeyName="states:process_template_id:process_templates.id"
                        references="process_templates(id)"
                        deleteCascade="true"/>
            </column>
            <column name="state_template_id" type="bigint">
                <constraints
                        nullable="false"
                        foreignKeyName="states:state_template_id:state_templates.id"
                        references="state_templates(id)"
                        deleteCascade="true"/>
            </column>
            <column name="is_fast_tracked" type="boolean" defaultValue="false">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create_table:transitions" author="Igor_M">
        <createTable tableName="transitions">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="from_state_id" type="bigint">
                <constraints foreignKeyName="transitions:from_state_id:states.id"
                             references="states(id)"
                             nullable="false"
                             deleteCascade="true"/>
            </column>
            <column name="to_state_id" type="bigint">
                <constraints
                        foreignKeyName="transitions:to_state_id:states.id"
                        references="states(id)"
                        nullable="false"
                        deleteCascade="true"/>
            </column>
            <column name="architect_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add_index:transitions:from_state_id" author="Igor_M">
        <createIndex tableName="transitions" indexName="idx:transitions:from_state_id">
            <column name="from_state_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="add_index:transitions:to_state_id" author="Igor_M">
        <createIndex tableName="transitions" indexName="idx:transitions:to_state_id">
            <column name="to_state_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="create_table:processes" author="Igor_M">
        <createTable tableName="processes">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="description" type="varchar(500)"/>
            <column name="object_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="owner_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="state_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="start_date" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="end_date" type="TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="add_foreign_key_constraint:processes:state_id:states.id" author="Igor_M">
        <addForeignKeyConstraint
                constraintName="fk_state_id"
                baseTableName="processes"
                baseColumnNames="state_id"
                onDelete="RESTRICT"
                referencedTableName="states"
                referencedColumnNames="id"
                validate="true"/>
    </changeSet>

    <changeSet id="add_index:processes:state_id" author="Igor_M">
        <createIndex tableName="processes" indexName="idx:processes:state_id">
            <column name="state_id"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>